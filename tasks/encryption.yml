---

- name: Install python pip
  ansible.builtin.package:
    name: python3-pip
    state: present

- name: Install pip module cryptography
  ansible.builtin.pip:
    name: cryptography
    state: present

- name: Generate private key
  community.crypto.openssl_privatekey:
    path: /etc/bareos/{{ bareos_fd_hostname }}-private.key
    owner: bareos
    group: bareos
    mode: "0600"

- name: Generate csr for public key
  community.crypto.openssl_csr:
    path: /etc/bareos/{{ bareos_fd_hostname }}-public.csr
    privatekey_path: /etc/bareos/{{ bareos_fd_hostname }}-private.key
    common_name: "{{ bareos_fd_hostname }}"
    owner: bareos
    group: bareos
    mode: "0644"

- name: Generate public key
  community.crypto.x509_certificate:
    path: /etc/bareos/{{ bareos_fd_hostname }}-public.key
    privatekey_path: /etc/bareos/{{ bareos_fd_hostname }}-private.key
    csr_path: /etc/bareos/{{ bareos_fd_hostname }}-public.csr
    provider: selfsigned
    owner: bareos
    group: bareos
    mode: "0644"

- name: Read private key
  ansible.builtin.slurp:
    src: /etc/bareos/{{ bareos_fd_hostname }}-private.key
  register: bareos_fd_encryption_private_key

- name: Read public key
  ansible.builtin.slurp:
    src: /etc/bareos/{{ bareos_fd_hostname }}-public.key
  register: bareos_fd_encryption_public_key

- name: Combine private and public key
  ansible.builtin.copy:
    content: "{{ bareos_fd_encryption_private_key.content | b64decode }}{{ bareos_fd_encryption_public_key.content | b64decode }}"
    dest: /etc/bareos/{{ bareos_fd_hostname }}.pem
    owner: bareos
    group: bareos
    mode: "0600"
  notify:
    - Check configuration
    - Restart bareos-filedaemon

- name: Place master public key
  ansible.builtin.copy:
    content: "{{ bareos_fd_encryption_master_public_key }}"
    dest: /etc/bareos/master.pub.key
    owner: bareos
    group: bareos
    mode: "0640"
  notify:
    - Check configuration
    - Restart bareos-filedaemon
